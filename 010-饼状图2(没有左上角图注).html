<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>d3.js-饼状图2(没有左上角图注)</title>
    <script type="text/javascript" src="http://d3js.org/d3.v5.min.js"></script>
    <style>
        svg {
            margin-top: 20px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            max-width: 150px;
            padding: 10px;
            font-size: 14px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .hidden {
            opacity: 0;
        }
        .show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <a href="https://wiki.jikexueyuan.com/project/d3wiki/scale.html" target="_blank" style="display: block;">文档</a>
    <a href="https://www.cnblogs.com/zhinian-/p/12575441.html" target="_blank" style="display: block;">文档V5</a>
    <a href="https://blog.csdn.net/cjy12138/article/details/85242833" target="_blank" style="display: block;">示例</a>
    <a href="https://www.jb51.net/article/93095.htm" target="_blank" style="display: block;">示例</a>
    
    <script>
        let width = 800,
            height = 500;
        let padding = {
            top: 30,
            left: 30,
            right: 300,
            bottom: 30
        };
        // 饼状图内、外圆半径
        let pieSetting = {
            innerRadius: 50,  // 内半径：为0则中间没有空白
            outerRadius: 100,
            changeOuterRadius: 110
        };
        
        let svg = d3.select('body')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);
        
        let data = [
            {label: '史部', value: 30},
            {label: '韦祁', value: 10},
            {label: '禹贾', value: 43},
            {label: '雷玛央', value: 55},
            {label: '薛远', value: 13}
        ]
        
        // ==========================================数据转换-将数据处理成d3所需要的（startAngle、endAngle等等）==========================================
        let pieLayout = d3.pie().value(d => d.value),   // 设置值访问器
            pieData = pieLayout(data);
        console.log(pieData)
        
        // ==========================================生成器-path可以绘制各种图形；使用生成器可以计算路径值+牵引线的三点位置==========================================
        let pieArc1 = d3.arc()  // 创建圆形、环形生成器
                       .innerRadius(pieSetting.innerRadius)  // 设置环的内半径
                       .outerRadius(pieSetting.outerRadius)  // 设置环的外半径
        // 供滑对应环，环变大的效果使用
        let pieArc2 = d3.arc()  
                       .innerRadius(pieSetting.innerRadius)
                       .outerRadius(pieSetting.changeOuterRadius)  // 设置滑上去变大效果的环的外半径 + 设置牵引线的起点
        let pieArc3 = d3.arc()  
                       .innerRadius(pieSetting.outerRadius * 1.2)
                       .outerRadius(pieSetting.outerRadius * 1.2)  // 设置牵引线中间的点
        let g = svg.selectAll('g')
                   .data(pieData)
                   .enter()
                   .append('g')
                   .attr('transform', `translate(${width / 2}, ${height / 2})`);
        
        // ==========================================设置颜色比例尺==========================================
        let colorScale = d3.scaleOrdinal(d3.schemeCategory10);
        
        // ==========================================添加path，绘制环==========================================
        let piePath = g.append('path')
                       .attr('fill', (d, i) => colorScale(i))  // 设置环的填充颜色
                       .attr('d', (d, i) => pieArc1(d));  // 使用生成器生成path的路径值
        
        g.append('text')
         .attr('transform', (d, i) => `translate(${pieArc1.centroid(d)})`)  // pieArc.centroid()：获取弧线中心
         .attr('fill', 'white')
         .attr('text-anchor', 'middle')  // 设置文本居中，text属性：https://blog.csdn.net/chy555chy/article/details/53354895
         .text((d, i) => d.value);
        
        // ==========================================tooltip==========================================
        let tooltip = d3.select('body')
                        .append('div')
                        .attr('class', 'tooltip hidden');

        // ==========================================滑上饼状图，环变大效果==========================================
        piePath.on('mouseover', function(d, i) {
                /* 呈现tooltip */
                tooltip.attr('class', 'tooltip show')
                       .style('left', `${d3.event.clientX + 10}px`)
                       .style('top', `${d3.event.clientY}px`)
                       .html(`${d.data.label}: ${d.value}`);
                /* 设置滑上变大 */
                d3.select(this)
                  .attr('d', (d, i) => pieArc2(d));
            })
            .on('mouseout', function(d, i) {
                /* 隐藏tooltip */
                tooltip.attr('class', 'tooltip hidden');
                /* 设置滑离复原 */
                d3.select(this)
                  .attr('d', (d, i) => pieArc1(d));
            })
        
        // ==========================================添加牵引线==========================================
        let polylineG = g.append('g');
        
        /* 饼状图的牵引线由3个点组成
        *  起点：为实际饼状图弧线的中点 
        *  中间的点：为虚拟的较大一点的饼状图弧线的中点
        *  终点：实际是中间的点平移得出，所以只需要算横坐标。横坐标-固定Npx（此处为150px/-150px），根据弧线的起始角度和终止角度计算；纵坐标-为虚拟的较大一点的饼状图弧线的中点的纵坐标
        */
        polylineG.append('polyline')
                 .attr('class', 'polyline')
                 .attr('points', (d, i) => {
                    let point1 = pieArc1.centroid(d),
                        point2 = pieArc3.centroid(d),
                        point3 = [pieSetting.outerRadius * (getX(d) < Math.PI ? 1.5 : -1.5), point2[1]];
                    return [point1, point2, point3];
                 })
                 .style('fill', 'none')
                 .style('stroke', (d, i) => colorScale(i))   // 设置虚线的颜色
                 .style('stroke-width', 3) // 设置虚线宽
                 .style('stroke-dasharray', '5 3');  // 设置虚线长5，间隔3
        /* 计算横坐标方向：150px还是-150px */
        function getX(d) {
            return d.startAngle + (d.endAngle - d.startAngle) / 2;
        }

        // ==========================================添加牵引线上的标注==========================================
        polylineG.append('text')
                 .attr('fill', (d, i) => colorScale(i))
                 .attr('x', (d, i) => getTextPos(d).x)
                 .attr('y', (d, i) => getTextPos(d).y)
                 .style('text-anchor', function(d, i) {
                    return getX(d) < Math.PI ? 'start' : 'end';  // 设置文本对齐方式
                 })
                 .text(d => `${d.data.label}: ${d.value}`);
        /* 获取文本位置 */
        function getTextPos(d) {
            let point2 = pieArc3.centroid(d),
                point3 = [pieSetting.outerRadius * (getX(d) < Math.PI ? 1.6 : -1.6), point2[1] + 6];
            return {
                x: point3[0],
                y: point3[1]
            }
        }
        
        // ==========================================添加图注==========================================
        let rectX = 10,
            rectW = 20,
            rectH = 10,
            rectPadding = 10;
        let notesG = svg.selectAll('g.notesG')
                       .data(pieData)
                       .enter()
                       .append('g')
                       .attr('class', 'notesG');
        /* 绘制矩形 */
        let notesRect = notesG.append('rect')
                              .attr('x', rectX)
                              .attr('y', (d, i) => (rectH + rectPadding) * (i + 1))
                              .attr('width', rectW)
                              .attr('height', rectH)
                              .attr('fill', (d, i) => colorScale(i));
        /* 绘制图注 */
        let noteText = notesG.append('text')
                             .attr('x', rectX + rectW + rectPadding)
                             .attr('y', (d, i) => (rectH + rectPadding) * (i + 1) + 10)
                             .style('font-size', '12px')
                             .attr('fill', (d, i) => colorScale(i))
                             .text((d) => `${d.data.label}: ${d.value}`);
        noteText.on('click', function() {
            console.log(d3.select(this))
        })
    </script>
</body>
</html>